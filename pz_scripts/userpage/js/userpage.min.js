/* Polyscope (c) 2016 */
var DATESORT={ASCENDING:0,DESCENDING:1};var CACHETIMEOUT=10000;var CACHETIMER=0;var items={dictionary:{},tags:[],caches:{single:0,multi:0}};var fileManager=null;var filterDialog=null;function generateSingleZoomEntry(c,a){var b='<td class="sampleSource"><div class="analysis"><img class="itemImage" title="'+c.name+'" src="'+c.image+'" indexPath="'+c.index+'" data-pathname="'+c.name+'" data-index="'+a+'" data-dzi="'+c.dzi+'" data-name="'+baseName(c.dzi[0])+'" data-type="singleZoom""></img></div></td>';return b}function generateMultiZoomEntry(c,a){var b='<td class="sampleSource"><div class="multizoom"><img class="itemImage" title="'+c.name+'" src="'+c.thumbnail+'" indexPath="'+c.index+'" data-pathname="'+c.name+'" data-index="'+a+'" data-setup="'+c.setupFile+'" data-name="'+c.name+'" data-type="multiZoom""></img></div></td>';return b}function isMultiZoom(a){return a.setupFile!==undefined}var fileOptions=FileManager.File.getDefaultConfig();fileOptions.createElement=function(c,b){var a=c.name;var d=items.dictionary[a];if(d===null){console.log("Project is not yet loaded or available. ",JSON.stringify(c));return""}if(!isMultiZoom(d)){return generateSingleZoomEntry(d,b)}else{return generateMultiZoomEntry(d,b)}console.log("Failed to create FILE entry. ["+JSON.stringify(c)+"]");return""};fileOptions.makeDraggable=function(){var a={appendTo:"body",scroll:false,revert:"invalid",cursor:"move",helper:"clone",start:function(d,e){var b=jQuery(e.helper[0]);var c=b.find(".itemImage");c.height(c.height());c.width(c.width())}};jQuery(".multizoom").draggable(a);jQuery(".analysis").draggable(a)};fileOptions.addToolTips=function(){jQuery("#sampleTable .itemImage").tooltip({content:function(){var c=jQuery(this);var b=c.data("index");var e=items.dictionary[b];var a=e.tags;var d=createToolTip(a);return d},open:function(a,b){jQuery("div.ui-helper-hidden-accessible").remove()}})};function generateDirectoryEntry(a,b){var c='<td class="sampleSource"><div class="directory"><img class="itemImage" title="'+a.name+'" src="./images/imagefiles-folder_icon_yellow.png" data-index="'+b+'" data-type="directory""><span class="directoryName" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: inline-block; vertical-align: middle; line-height: normal">'+a.name+"</span></img></div></td>";return c}var directoryOptions=FileManager.Directory.getDefaultConfig();directoryOptions.createElement=function(b,a){return generateDirectoryEntry(b,a)};directoryOptions.makeDraggable=function(){var a={appendTo:"body",scroll:false,revert:"invalid",cursor:"move",helper:"clone",start:function(d,e){var b=jQuery(e.helper[0]);var c=b.find(".itemImage");c.height(c.height());c.width(c.width())}};jQuery(".directory").draggable(a)};function makeDirectoriesAcceptDrops(){jQuery(".directory").droppable({tolerance:"pointer",accept:"div, .itemImage",drop:function(a,b){var c=jQuery(this).find(".itemImage").data("index");doDropItemsIntoDirectory(c,a,b)}})}var itemsToBeModified=[];var absolutePathsOfItems=[];function doDropItemsIntoDirectory(d,b,c){var a=getAllItemsToBeModified(b,c);fileManager.moveItems(a,fileManager.fullItemPath(d))}function getAllItemsToBeModified(c,d){var a=null,e=getSelectedItems(),b=jQuery(e).find(".itemImage").map(function(){return jQuery(this).data("index")}).get();if(c!==undefined&&d!==undefined&&c.type!=="menuselect"){a=jQuery(d.helper[0]).find(".itemImage").data("index");b.push(a)}absolutePathsOfItems=fileManager.fullItemsPath(b);return b}directoryOptions.addToolTips=function(){};function generateParentEntry(c,a){var b='<td class="sampleSource"><div class="parent"><img class="itemImage" title="'+c.path+'" src="./images/parent.png" data-index="'+a+'" data-type="parent""></img></div></td>';return b}var parentOptions=FileManager.Parent.getDefaultConfig();parentOptions.createElement=function(b,a){return generateParentEntry(b,a)};var directoryType=new FileManager.Directory(directoryOptions);var fileType=new FileManager.File(fileOptions);var parentType=new FileManager.Parent(parentOptions);var onFileManagerRedraw=function(){doApplyImageMagnification(g_currentMagnification);fileOptions.makeDraggable();directoryOptions.makeDraggable();makeDirectoriesAcceptDrops()};function titleFromIndex(a){var b="";if(a===0){b="Patientname"}else{if(a===1){b="Channelname"}else{b="Template Selection Tag"}}return b}function createTagSpan(c){var b=c.split("_");var d='<span class="tag tagIdx0" title="Patientname" data-key="tagIdx0" >'+b[0]+"</span>";for(var a=1;a<b.length;++a){d=d+'_<span class="tag tagIdx'+a+'" title="'+titleFromIndex(a)+'" data-key="tagIdx'+a+'" >'+b[a]+"</span>"}return d}function toggleSpan(b){var b=jQuery(b);var a=b.data("key");var c=jQuery("."+a);if(b.hasClass("spanActive")){c.toggleClass("spanActive");c.toggleClass("spanMatch")}else{if(c.hasClass("spanMatch")){c.toggleClass("spanMatch")}else{c.toggleClass("spanActive")}}}jQuery(document).on("click","span.tag",function(){toggleSpan(this)});jQuery(".button.deleteZooms").droppable({tolerance:"touch",accept:"div",drop:function(d,e){var b=getAllItemsToBeModified(d,e);if(e===undefined||d===undefined){return}var a=jQuery(e.helper[0]);var f=a.find("itemImage").attr("indexPath");var c=[];c.push(f);deleteZooms(c)}});jQuery(".raster").droppable({tolerance:"pointer",accept:"div.analysis, div.multizoom",drop:function(a,b){doDropFileIntoRaster(a,b)}});function doDropFileIntoRaster(b,h){if(b===undefined||h===undefined){console.log("Event or UI are undefined!");return}var c=jQuery(h.helper[0]);var m=c.find(".itemImage");var f=m.data("type");if(f==="singleZoom"){raster.dropAt(b.pageX,b.pageY,h.helper[0].outerHTML)}else{if(f==="multiZoom"){var e=jQuery(m).data("index");if(e==="#"){return}var k=items.dictionary[e];if(k==="undefined"){return}var j=k.setupContent;var d=interpretSetupContent(j,pathName(k.setupFile));raster=new Raster(".raster",d.x,d.y);for(var g=0;g<d.y;++g){for(var i=0;i<d.x;++i){var e=g+i*d.y;var m=d.items[e];if(m!==null){var l=createTagSpan(baseName(m.dzi));var a=createInternalSampleEntry(m.index,m.thumbnail,baseName(m.dzi),m.dzi,"#",baseName(m.dzi),l);raster.setItem(i,g,a)}}}raster.createGrid();raster.refresh()}else{console.log("Tried to drop improper type!")}}}var g_email="";var raster=new Raster(".raster",1,1);raster.doTableResize(1,1);var removedItems=[];ServerRefresh();getEmail();adjustHeader();resizeActions();function interpretSetupContent(g,j){var d=g.split("\n");var b=new Object();b.x=parseInt(d[0],0);b.y=parseInt(d[1],0);b.email=d[2];b.items=[];var a=3;var e=2;for(var h=0;h<b.x;++h){for(var f=0;f<b.y;++f){var i=new Object();var c=a+(f+b.y*h)*e;i.dzi=d[c];if(!i.dzi.trim()){i=null}else{i.alpha=(parseInt(d[c+1],0)===1);i.thumbnail=j+"/"+(h+1)+"_"+(f+1)+".png";i.index=dziToIndexPath(i.dzi)+"/index.html"}b.items.push(i)}}return b}jQuery(window).resize(function(){resizeActions()});jQuery("#applyTemplate").click(function(){var b=jQuery(".sampleCell");var h=jQuery(".sampleCell .analysis");var f=[];for(var e=0;e<h.length;++e){var k=new Object();var g=jQuery(h[e]).find(".tag");var a=jQuery(g).filter(".spanActive");var c=jQuery(g).not(".spanActive");k.tags=[];for(var d=0;d<g.length;++d){k.tags.push(jQuery(g[d]).innerHTML)}k.diffTag=[];for(var d=0;d<a.length;++d){k.diffTag.push(jQuery(a[d]).innerHTML)}k.stayTag=[];for(var d=0;d<c.length;++d){k.stayTag.push(jQuery(c[d]).innerHTML)}f.push(k)}var c=[];for(var e=1;e<f.length;++e){c=_.intersection(c,f[e].stayTag)}});jQuery("#sendCode").click(function(){requestSendCode()});jQuery("#startAnalysis").click(function(){var b=getDziFiles(getAllItemsToBeModified());var c="CRImage";var a=showWarning("You are going to process "+b.length+" samples\nwith "+c+"\nAre you sure?");if(a){startAnalysis(b,c)}else{alert("Processing was canceled.")}});jQuery(".button#startAnalysis").droppable({tolerance:"touch",accept:"div",drop:function(c,d){if(d===undefined||c===undefined){return}var a=jQuery(d.helper[0]);var e=a.find("img.itemImage").data("dzi");var b=[];b.push(e);var f="CRImage";startAnalysis(b,f)}});function startAnalysis(c,b){var a=c.length;if(a===0){window.alert("There are no Zooms to be analyzed!");return}requestAnalysis(c,b)}function requestAnalysis(b,a){var d=[];for(var c=0;c<b.length;++c){d.push(b[c].toString().split("/").pop())}var f={path:b,app:a,email:g_email,parameter:"",sampleName:d};var e=serverRequest("issueApp.php","params="+JSON.stringify(f),function(){switch(e.readyState){case 4:if(e.status!==200){}else{var h=JSON.parse(e.responseText);var n=0;for(var k=0;k<h.length;++k){var g=h[k];var m=g.message;if(m.indexOf("[INFO]")!==-1){++n}}var j="jobs were";if(n===1){j="job was"}var l=n+" "+j+" successfully submitted.";window.alert(l)}e=null}},null)}jQuery("div.button.deleteZooms").click(function(){var a=getIndexFiles(getAllItemsToBeModified());deleteZooms(a)});function deleteZooms(c){var d=c.length;if(d===0){window.alert("There are no Zooms to be deleted!");return}var b="Warning: You are going to delete "+d+" Zooms!\nAre you serious? (1/2)";var a=showWarning(b);if(a===true){var b="Warning: Those "+d+" Zooms will be immediatly removed!\nAre you sure? (2/2)";var a=showWarning(b);if(a===true){var e=window.prompt("Please enter your USER code:","000000");if(e!==null){requestRemoveZooms(e,c)}else{window.alert("User code invalid, deletion aborted.")}}else{window.alert("Deletion aborted.")}}else{window.alert("Deletion aborted.")}}function getSpecificItems(b){var d=[],a=0,c="";for(a=0;a<b.length;++a){c=b[a];d.push(items.dictionary[c])}return d}function getSpecificItemsProperty(a,c){var b=[];b=a.map(function(d){return d[c]});return b}function getPropertyForSelection(a,b){var c=getSpecificItems(a);return getSpecificItemsProperty(c,b)}function getIndexFiles(a){return getPropertyForSelection(a,"index")}function getDziFiles(b){var c=getPropertyForSelection(b,"dzi");var d=[];for(var a=0;a<c.length;++a){d.push(c[a][0])}return d}function requestRemoveZooms(c,b){var a=serverRequest("removeZooms.php","usercode="+JSON.stringify(c)+"&files="+JSON.stringify(b),function(){switch(a.readyState){case 4:if(a.status!==200){}else{var d=JSON.parse(a.responseText);window.alert(d.message);ServerRefresh();ServerRefreshMulti()}a=null}},null)}function showWarning(b){var a=confirm(b);return a===true}function requestSendCode(){var a=serverRequest("sendCode.php","",function(){switch(a.readyState){case 4:if(a.status!==200){}else{}a=null}},null)}jQuery("#createZoom").click(function(){doMultiZoom()});jQuery(".button.sort").click(function(){fileFilter.sortOrder=Math.abs(fileFilter.sortOrder-1);fileManager.refresh(true)});var filterTimeout=0;var wasDialogShown=false;jQuery(".button.filter").mousedown(function(){filterTimeout=setTimeout(doDisplayFilterDialog,1000)}).bind("mouseup mouseleave",function(){if(filterTimeout!==0){clearTimeout(filterTimeout);applyFilter(false);filterTimeout=0}});function getSelectedItems(){return jQuery(".selected")}function getSelectedItemsData(a){var b=getSelectedItems();return b.map(function(){return jQuery(this).find(".itemImage").data(a)})}function doDisplayFilterDialog(){filterDialog=displayFilterDialog(filterDialog,items.tags)}function displayFilterDialog(j,o){var a=320,l=320,b=0.4,i=0.8,k="auto",m=0.85,h="dd/mm/yy";o=o.sort();if(j===null){j=createFilterDialog();var d=document.getElementById("sortingmenu").appendChild(j);jQuery("#"+j.id+" #dateFrom").datepicker({dateFormat:h});jQuery("#"+j.id+" #dateTo").datepicker({dateFormat:h});j.tags=o;setFilterTagsForSelection(j,o);jQuery("#"+j.id+" #tagselector :checkbox").prop("checked",false);jQuery("#"+j.id+" #tagActive").bind("change",function(){var p=this.checked;if(p){jQuery("#"+j.id+" #tagBlocker").hide()}else{var q=jQuery("#"+j.id+" #tagselector");jQuery("#"+j.id+" #tagBlocker").width(q.width()).height(q.height()).show();jQuery("#"+j.id+" #tagBlocker").position({of:q,my:"center",at:"center"})}})}else{if(j.tags.length!==o.length){setFilterTagsForSelection(j,o)}}var g=jQuery(window).width();var e=jQuery(window).height();var f=Math.max(a,g*b);var c=Math.max(l,e*i);jQuery("#"+j.id+" #tagselector").height(k).width(f*m);var n=jQuery("#"+j.id+" #tagselector");jQuery("#"+j.id+" #tagBlocker").width(n.width()).height(n.height());jQuery("#"+j.id).dialog({dialogClass:"noclose",minWidth:a,minHeight:l,maxWidth:f,maxHeight:c,width:f,height:c,autoOpen:true,modal:true,open:function(r,t){$(".ui-dialog-titlebar-close",t.dialog||t).hide();wasDialogShown=true;var q=$(".filterTable").outerHeight();var s=jQuery("#"+j.id).outerHeight();var v=s-q;var p=jQuery("#"+j.id+" #tagselector").height();jQuery("#"+j.id+" #tagselector").height(p+v);var u=jQuery("#"+j.id+" #tagselector");jQuery("#"+j.id+" #tagBlocker").width(u.width()).height(u.height()).show();jQuery("#"+j.id+" #tagBlocker").position({of:u,my:"center",at:"center"})},buttons:{Ok:function(){jQuery(this).hide();jQuery(this).dialog("close");applyFilter(true);fileManager.refresh(true)},Cancel:function(){jQuery(this).hide();jQuery(this).dialog("close")}}});return j}function setFilterTagsForSelection(c,a){jQuery("#"+c.id+" #tagselector p").remove();for(var b=0;b<a.length;++b){jQuery("#"+c.id+" #tagselector").append('<p><label><input type="checkbox" name="selectedTags[]" class="selectedTag" value="'+b+'" />'+a[b]+"</label></p>")}}function createFilterDialog(){var a=document.createElement("div");a.setAttribute("id","filterDialog-"+Math.floor(Math.random()*10000));a.setAttribute("title","Filter Dialog");a.style.display="none";a.innerHTML='<table class="filterTable"><tr><td style="border-bottom: 1px solid #00AAFF;">Date Filter:<br><input type="checkbox" id="dateFromActive" value="dateFromActive"> From<br><input type="text" id="dateFrom"><br><input type="checkbox" id="dateToActive" value="dateToActive"> To<br><input type="text" id="dateTo"><br></td></tr><tr><td style="border-bottom: 1px solid #00AAFF;">Text Filter:<br><input type="text" id="textPattern"><br></td></tr><tr><td>Tag Filter:<br><div id="tagBlocker" class="tagBlocker"></div><input type="checkbox" id="tagActive" value="tagActive"> Available Tags<br><div id="tagselector" class="selectionList"></div></td></tr></table>';return a}function resizeActions(){adjustHeader();var b=jQuery(".button");var a=jQuery(b[0]).height();b.width(a);raster.refresh()}function adjustHeader(){jQuery(".headerbubble").position({my:"center",at:"center",of:"#header"})}function clearList(a){jQuery("#"+a+" tbody").html("")}function ServerRefresh(){var a=serverRequest("getCustomerProjects.php","",function(){switch(a.readyState){case 4:if(a.status!==200){}else{var c=JSON.parse(a.responseText);c=removeEmptyProjects(c);c=createDates(c);c=fillSampleData(c);for(var b=0;b<c.length;++b){var d=c[b];items.dictionary[d.name]=d}if(items.caches.single===0){requestCacheVersion();ServerRefreshMulti()}}a=null}},null)}jQuery("div.refresh").click(function(){if(jQuery("div.refresh").hasClass("active")){jQuery("div.refresh").removeClass("active")}items.caches.single=0;items.caches.multi=0;ServerRefresh()});function requestCacheVersion(){var a=serverRequest("getCustomerProjects.php","version=1",function(){switch(a.readyState){case 4:if(a.status!==200){}else{var b=JSON.parse(a.responseText);if(items.caches.single===0){items.caches.single=b.md5}else{if(items.caches.single!==b.md5){jQuery("div.refresh").addClass("active")}}if(CACHETIMER!==0){clearTimeout(CACHETIMER);CACHETIMER=0;CACHETIMER=setTimeout(requestCacheVersion,CACHETIMEOUT)}else{CACHETIMER=setTimeout(requestCacheVersion,CACHETIMEOUT)}}a=null}},null)}function requestMultiCacheVersion(){var a=serverRequest("getCustomerProjectsMulti.php","version=1",function(){switch(a.readyState){case 4:if(a.status!==200){}else{var b=JSON.parse(a.responseText);if(items.caches.multi===0){items.caches.multi=b.md5}else{if(items.caches.multi!==b.md5){jQuery("div.refresh").addClass("active")}}if(CACHETIMER!==0){clearTimeout(CACHETIMER);CACHETIMER=0;CACHETIMER=setTimeout(requestMultiCacheVersion,CACHETIMEOUT)}else{CACHETIMER=setTimeout(requestMultiCacheVersion,CACHETIMEOUT)}}a=null}},null)}function ServerRefreshMulti(){var a=serverRequest("getCustomerProjectsMulti.php","",function(){switch(a.readyState){case 4:if(a.status!==200){}else{var c=JSON.parse(a.responseText);c=c.filter(function(f){return f!==null});c=createDates(c);for(var b=0;b<c.length;++b){var d=c[b];items.dictionary[d.name]=d}if(items.caches.multi===0){requestMultiCacheVersion();items.tags=getTags(items.dictionary);fileManager=new FileManager.FileManager("sampleTable",[fileType,directoryType,parentType],1,onFileManagerRedraw,function(e){return cleanItems(e)});fileManager.setFilter(function(e){return doFilter(e)})}}a=null}},null)}function createDates(b){for(var a=0;a<b.length;++a){var c=b[a].fileDate.date;b[a].fileDate=parseDate(c)}return b}function parseDate(d){var c=d.replace(/ /g,"-");c=c.replace(/:/g,"-");var a=c.split("-");var b=new Date(a[0],a[1]-1,a[2],a[3],a[4],a[5]);b=Date.parse(b);return b}function convertDate(b){var c=b.split("/");var a=new Date(parseInt(c[2],10),parseInt(c[1],10)-1,parseInt(c[0],10));return a}function removeEmptyProjects(b){removedItems=[];for(var a=b.length-1;a>=0;--a){if(b[a].dzi.length===0){var c=b.splice(a,1);removedItems.push(c)}}console.log("There were items which could not be resolved: "+JSON.stringify(removedItems));return b}function fillSampleData(d){for(var c=0;c<d.length;++c){var a=baseName(d[c].dzi[0]);d[c].dziName=a;var e=d[c].name.split("_");var b=a.split("_");d[c].tags=e.concat(b)}return d}function sortByDateAscending(d,c){return items.dictionary[d].fileDate-items.dictionary[c].fileDate}function sortByDateDecending(d,c){return items.dictionary[c].fileDate-items.dictionary[d].fileDate}function sortByName(d,c){return d.localeCompare(c)}function getOlderThan(d,c){var b=[];for(var a=0;a<d.length;++a){if(items.dictionary[d[a]].fileDate<=c){b.push(d[a])}}return b}function getNewerThan(d,c){var b=[];for(var a=0;a<d.length;++a){if(items.dictionary[d[a]].fileDate>=c){b.push(d[a])}}return b}function getTags(c){var a=[];if(c.length>0){a=[];for(var b=0;b<c.length;++b){a=_.union(a,items.dictionary[c[b]].tags)}}return a}function filterByText(c,d){var b=[];for(var a=0;a<c.length;++a){if(items.dictionary[c[a]].name.indexOf(d)>-1||items.dictionary[c[a]].dziName&&items.dictionary[c[a]].dziName.indexOf(d)>-1){b.push(c[a])}}return b}function filterByTags(d,a){var c=[];for(var b=0;b<d.length;++b){if(_.intersection(items.dictionary[d[b]].tags,a).length>0){c.push(d[b])}}return c}var fileFilter=getEmptyFilter();function getEmptyFilter(){return{fromDate:null,toDate:null,textPattern:null,tags:null,sortOrder:DATESORT.DESCENDING}}function doFilter(c){var b=Object.keys(c);if(fileFilter.fromDate){b=getNewerThan(b,fileFilter.fromDate)}if(fileFilter.toDate){b=getOlderThan(b,fileFilter.toDate)}if(fileFilter.textPattern){b=filterByText(b,fileFilter.textPattern)}if(fileFilter.tags){b=filterByTags(b,fileFilter.tags)}var a=splitFoldersFromRest(b,c);if(a.files.length>1){a.files=sortByDate(a.files,fileFilter.sortOrder)}if(a.folders.length>1){a.folders=a.folders.sort(sortByName)}return a.folders.concat(a.files)}function splitFoldersFromRest(g,f){var c=[],e=[];for(var b=0;b<g.length;++b){var a=g[b];var d=f[a].type;if(d==="DIR"){c.push(a)}else{e.push(a)}}return{folders:c,files:e}}function cleanItems(c){var b={};for(var a in c){if(items.dictionary[a]){b[a]=c[a]}else{}}return b}function applyFilter(d){if(filterDialog===null){return}var b=filterDialog.id;fileFilter=getEmptyFilter();if(!jQuery(".button.filter").hasClass("filterOn")||d){if(jQuery("#"+b+" #dateFromActive").is(":checked")){var c=convertDate(jQuery("#"+b+" #dateFrom").val());fileFilter.fromDate=Date.parse(c)}if(jQuery("#"+b+" #dateToActive").is(":checked")){var a=convertDate(jQuery("#"+b+" #dateTo").val());fileFilter.toDate=Date.parse(a)}if(jQuery("#"+b+" #textPattern").val()!==""){fileFilter.textPattern=jQuery("#"+b+" #textPattern").val()}jQuery(".button.filter").addClass("filterOn")}else{jQuery(".button.filter").removeClass("filterOn")}}function getSelections(c){var a=jQuery(c);var b=[].map.call(a,function(d){if(d.checked){return d.value}else{return""}});b=b.filter(function(d){return d!==""});return b}function sortByDate(a,b){if(b===DATESORT.DESCENDING){a.sort(sortByDateDecending)}else{a.sort(sortByDateAscending)}return a}function createToolTip(a){var c="";for(var b=0;b<a.length;++b){c=c+a[b]+"<br>"}return c}function createInternalSampleEntry(e,a,c,b,g,d,h){var f='<div class="analysis"><div id="'+d+'" class="templatetagger">'+h+'</div><img class="itemImage" title="'+c+'" src="'+a+'" indexPath="'+e+'" data-index="'+g+'" data-dzi="'+b+'" data-name="'+d+'"></img></div>';return f}function getEmail(){var a=serverRequest("getEmail.php","",function(){switch(a.readyState){case 4:if(a.status!==200){}else{var b=JSON.parse(a.responseText);g_email=b;jQuery("#header").find("p:last").html(b)}a=null}},null)}function doMultiZoom(){var b=generateLayout(raster);if(b===null){return}b.email=g_email;var a=serverRequest("createMultiZoom.php","layout="+JSON.stringify(b),function(){switch(a.readyState){case 4:if(a.status!==200){}else{var c=JSON.parse(a.responseText);window.open(c,"_blank")}a=null}},null)}function generateLayout(b){var d=new Object();d.rows=b.rows;d.cols=b.cols;d.table=new Array(d.cols);var e=d.rows*d.cols;var c=0;for(var a=0;a<d.cols;++a){d.table[a]=new Array(d.rows);for(var f=0;f<d.rows;++f){d.table[a][f]=new Object();if(b.table[a][f].item!==null){d.table[a][f].dzi=jQuery(b.table[a][f].item).find("img").data("dzi");d.table[a][f].alpha=jQuery(b.table[a][f].item).hasClass("alpha-item")}else{d.table[a][f].dzi="";d.table[a][f].alpha=false;++c}}}if(c===e){d=null}return d}function baseName(b){var a=new String(b).substring(b.lastIndexOf("/")+1);if(a.lastIndexOf(".")!==-1){a=a.substring(0,a.lastIndexOf("."))}return a}function pathName(b){var a=new String(b).substring(0,b.lastIndexOf("/"));return a}function dziToIndexPath(b){var c=new String(b).substring(0,b.lastIndexOf("/")-1);var a=new String(c).substring(0,c.lastIndexOf("/"));return a}var jobDialog=null;jQuery(".button#zoomJobs").click(function(){jobDialog=displayJobDialog(jobDialog)});function createJobDialog(){var a=document.createElement("div");a.setAttribute("id","job-"+Math.floor(Math.random()*10000));a.setAttribute("title","Job Dialog");a.style.display="none";a.innerHTML='<table class="jobTable"><tr><td style="border-bottom: 1px solid #00AAFF;">Zooms in queue:<br><div id="zoomList" class="zoomList"></td></tr><tr><td style="border-bottom: 1px solid #00AAFF;">Analyses in queue:<br><div id="analysisList" class="analysisList"></td></tr></table>';return a}function displayJobDialog(i){var a=320,l=320,b=0.95,h=0.95,k="auto",m=0.85;getJobs();if(i===null){i=createJobDialog();var d=document.getElementById("sortingmenu").appendChild(i)}if(g_jobs===null){return}var j=getJobInfos(g_jobs.zoom,g_jobs.analysis);var g=jQuery(window).width();var e=jQuery(window).height();var f=Math.max(a,g*b);var c=Math.max(l,e*h);jQuery("#"+i.id).dialog({dialogClass:"noclose",minWidth:a,minHeight:l,maxWidth:f,maxHeight:c,width:f,height:c,autoOpen:true,modal:true,open:function(q,s){$(".ui-dialog-titlebar-close",s.dialog||s).hide();var p=j.jobs;var r=jQuery("<ul></ul>");for(var o=0;o<p.length;++o){var n=jQuery("<li></li>");n[0].innerText=p[o];r.append(n)}jQuery(".zoomList").find("ul").remove();jQuery(".zoomList").append(r);var p=j.analyses;var r=jQuery("<ul></ul>");for(var o=0;o<p.length;++o){var n=jQuery("<li></li>");n[0].innerHTML=p[o];r.append(n)}jQuery(".analysisList").find("ul").remove();jQuery(".analysisList").append(r)},buttons:{Ok:function(){jQuery(this).hide();jQuery(this).dialog("close")},Cancel:function(){jQuery(this).hide();jQuery(this).dialog("close")}}});return i}function getJobInfos(a,d){var c=[];for(var f=0;f<a.length;++f){var h=a[f];h=h.data;var b=h.statusId+" - "+h.status+": "+h.origFilename;c.push(b)}var g=[];var e=[];for(var f=0;f<d.length;++f){var h=d[f];h=h.data;var b=h.statusId+" - "+h.status+": "+h.sourcefile+" => "+h.appName+'(<a href="'+h.md5+'">log</a>)';g.push(b)}return{jobs:c,analyses:g}}function getJobs(){var a=serverRequest("getJobs.php","",function(){switch(a.readyState){case 4:if(a.status!==200){}else{var b=JSON.parse(a.responseText);g_jobs=b}a=null}},null)}var g_jobs=null;jQuery(".button").tooltip();jQuery(".refresh").tooltip();getJobs();var splitterConfig={splitterItems:[{name:"leftpane",startWidth:270,minWidth:270},{name:"rightpane",startWidth:0,minWidth:270}],splitterCss:"splitterCss",splitterHoverCss:"splitterHoverCss"};function addSplitter(b){var c="#"+b.splitterItems[0].name;var a=jQuery(c);$('<div id="splitter" class="splitter"></div>').insertAfter(c).addClass(b.splitterCss).mouseenter(function(){jQuery(".splitter").addClass(splitterConfig.splitterHoverCss)}).mouseleave(function(){jQuery(".splitter").removeClass(splitterConfig.splitterHoverCss)})}addSplitter(splitterConfig);var fileOpItems=[];var lastFileOp=null;function clearClipboard(){fileOpItems=[];lastFileOp=null}function pasteItems(a,b){if(fileOpItems.length>0){if(lastFileOp==="copy"){fileManager.copyItems(absolutePathsOfItems,fileManager.currentDirectory,"")}if(lastFileOp==="cut"){fileManager.moveItems(absolutePathsOfItems,fileManager.currentDirectory,"")}}clearClipboard()}function copyItems(a,b){fileOpItems=getAllItemsToBeModified(a,b);lastFileOp="copy"}function cutItems(a,b){fileOpItems=getAllItemsToBeModified(a,b);lastFileOp="cut"}var contextMenu=[{title:"Paste",cmd:"paste",action:function(a,b){pasteItems(a,b)}},{title:"Copy",cmd:"copy",action:function(a,b){copyItems(a,b)}},{title:"Cut",cmd:"cut",action:function(a,b){cutItems(a,b)}},{title:"----"},{title:"Clear clipboard",cmd:"clear",action:function(a,b){clearClipboard()}}];jQuery(document).contextmenu({delegate:".sampleSource",menu:contextMenu,beforeOpen:function(a,b){var c=(fileOpItems.length>0);jQuery(document).contextmenu("enableEntry","paste",c);jQuery(document).contextmenu("enableEntry","copy",!c);jQuery(document).contextmenu("enableEntry","cut",!c);jQuery(document).contextmenu("enableEntry","clear",c)}});var g_currentMagnification=0;var g_baseWidth=(jQuery(".samplelist table").width()*0.9)||256;var g_currentWidth=0;$(function(){$(".verticalSlider").slider({orientation:"vertical",range:"min",min:0,max:6,value:4,slide:function(a,b){g_currentMagnification=b.value-4;doApplyImageMagnification(g_currentMagnification);adjustColumnCount()}})});function doApplyImageMagnification(b){var a=Math.pow(2,b)*g_baseWidth;jQuery(".samplelist table img").width(a+"px");jQuery(".directoryName").width(a+"px");g_currentWidth=jQuery(".samplelist table img").outerWidth()}jQuery("#createFolder").click(function(){var a=prompt("Please enter a folder name:","New Folder");fileManager.addDirectory(a)});function addSplitterHover(){jQuery(".splitter").mouseenter(function(){jQuery(this).addClass("over")});jQuery(".splitter").mouseleave(function(){jQuery(this).removeClass("over")});jQuery(".splitter").draggable({helper:"original",containment:".pageContainer",cursor:"grab",iframeFix:true,axis:"x",start:function(a,b){jQuery(this).addClass("force");applySplitterDrag(a,b)},drag:function(a,b){applySplitterDrag(a,b)},stop:function(a,b){jQuery(this).removeClass("force");applySplitterDrag(a,b);adjustColumnCount()}})}function applySplitterDrag(d,f){var h=jQuery(".leftpane");var c=parseInt(h.css("min-width"),10);var e=c+f.offset.left;var a=jQuery(".pageContainer").innerWidth();var g=Math.min(Math.max(e/a,0),1);g=Math.floor(g*a)/a;var b=1-g;doResize(g,b);console.log(Math.floor(g*a))}function scale(b,a){return b*(1-a/b)}function doResize(h,g){var i=6;var b=jQuery(".pageContainer");var a=b.innerWidth();a=scale(a,i);var d=Math.floor(a*h);var f=jQuery(".leftpane");var c=jQuery(".rightpane");var e=jQuery(".splitter");f.width(d+"px");e.css("left",(d-parseInt(e.css("margin-left"),10))+"px");c.css("left",(d+i)+"px")}function realListWidth(){return jQuery(".leftpane").innerWidth()-jQuery(".sortingmenu").outerWidth()-tools.scrollbarWidth()}function getCellSize(){var a=$("#sampleTable td").outerWidth();if(a-g_currentWidth>25&&(a/g_currentWidth)-1>0.5){return g_currentWidth+(g_currentWidth%2)}else{return a+(a%2)+2}}function adjustColumnCount(){var a=realListWidth();var b=Math.max(Math.floor(a/Math.ceil(getCellSize())),1);fileManager.changeColumnCount(b)}function onLoad(){addSplitterHover()}jQuery(document).on("click",".analysis",function(){jQuery(this).toggleClass("selected")});jQuery(document).on("dblclick",".analysis .itemImage",function(){var a=jQuery(this).attr("indexPath");window.open(a,"_blank")});jQuery(document).on("click",".multizoom",function(){jQuery(this).toggleClass("selected")});jQuery(document).on("dblclick",".multizoom .itemImage",function(){var a=jQuery(this).attr("indexPath");window.open(a,"_blank")});jQuery(document).on("click",".directory",function(){jQuery(this).toggleClass("selected")});jQuery(document).on("dblclick",".directory .itemImage",function(){if(fileManager!==undefined&&fileManager!==null){var b=jQuery(this).data("index");var a=fileManager.fullItemPath(b);fileManager.updateDirectory(a)}});jQuery(document).on("dblclick",".parent .itemImage",function(){if(fileManager!==undefined&&fileManager!==null){var a=jQuery(this).data("index");fileManager.updateDirectory(a)}});